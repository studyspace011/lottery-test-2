<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Ledger – By Aavid</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.7.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --bg-light: #f3f4f6; --text-light: #1f2937; --card-light: rgba(255, 255, 255, 0.6); --border-light: rgba(209, 213, 219, 0.4);
            --bg-dark: #0f172a;  --text-dark: #e2e8f0;  --card-dark: rgba(30, 41, 59, 0.6); --border-dark: rgba(71, 85, 105, 0.4);
            --primary: #4f46e5; --primary-hover: #4338ca;
            --input-bg-light: #fff; --input-bg-dark: #1e293b;
        }
        html.dark { color-scheme: dark; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-light); color: var(--text-light);
            transition: background-color 0.3s ease;
        }
        .dark body { background-color: var(--bg-dark); color: var(--text-dark); }
        .glass-card {
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: all 0.3s ease;
        }
        .dark .glass-card { background-color: var(--card-dark); border-color: var(--border-dark); }
        .form-input {
            background-color: var(--input-bg-light);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }
        .form-input:focus {
             box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
             border-color: var(--primary); outline: none;
        }
        .dark .form-input { background-color: var(--input-bg-dark) !important; border-color: #334155 !important; color: #f1f5f9 !important; }
        .session-morning { background-color: rgba(252, 211, 77, 0.1); }
        .session-day { background-color: rgba(59, 130, 246, 0.1); }
        .session-night { background-color: rgba(16, 185, 129, 0.1); }
        #toast-notification { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.75rem; font-weight: 600;
            padding: 8px 4px; width: 100%; border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .nav-btn:hover { background-color: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .nav-btn.active { background-color: var(--primary); color: white; }
        .page-title {
             font-size: 1.875rem; font-weight: 800;
             letter-spacing: -0.025em;
             background: linear-gradient(to right, #4f46e5, #7c3aed);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
        }
        .dark .page-title {
             background: linear-gradient(to right, #818cf8, #a78bfa);
             -webkit-background-clip: text;
        }
        .btn {
            padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 700;
            text-align: center; transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .dark .btn-secondary { background-color: #334155; color: #e2e8f0; }
        .btn-secondary:hover { background-color: #cbd5e1; transform: translateY(-2px); }
        .dark .btn-secondary:hover { background-color: #475569; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="page-title">Lottery Ledger</h1>
        </header>

        <main id="content-area" class="pb-24"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-2xl mx-auto p-2 z-20">
            <div class="flex justify-around bg-white/70 dark:bg-slate-800/70 p-2 rounded-2xl shadow-lg backdrop-filter backdrop-blur-lg border border-gray-200/50 dark:border-gray-700/50">
                <button onclick="App.navigate('home')" id="nav-home" class="nav-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>Entry</span>
                </button>
                <button onclick="App.navigate('report')" id="nav-report" class="nav-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Report</span>
                </button>
                <button onclick="App.navigate('dashboard')" id="nav-dashboard" class="nav-btn">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Dashboard</span>
                </button>
                <button onclick="App.navigate('settings')" id="nav-settings" class="nav-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <div id="toast-notification" class="fixed bottom-24 right-5 z-50 p-4 text-white font-semibold rounded-lg shadow-xl opacity-0 transform translate-y-10"></div>

    <script>
        // =================================================================================
        // APP MODULE (La lógica de JavaScript sigue siendo la misma)
        // =================================================================================
        const App = (() => {
            // --- STATE MANAGEMENT ---
            let state = {
                currentPage: 'home',
                data: {},
                settings: {
                    rate: 4.30,
                    developerName: 'Your Name',
                    theme: 'light'
                },
                reportDate: new Date().toISOString().split('T')[0],
                dashboardDate: {
                    month: new Date().getMonth() + 1,
                    year: new Date().getFullYear()
                }
            };
            const APP_KEY = 'lotteryLedgerData';
            const SETTINGS_KEY = 'lotteryLedgerSettings';

            // --- EMAILJS CONFIG ---
            const EMAILJS_CONFIG = {
                publicKey: 'cR_ecVOlooNvaufB0',
                serviceId: 'service_wc19lto',
                templateId: 'template_grmabah'
            };

            // --- CORE & UTILITIES ---
            const init = () => {
                loadSettings();
                loadData();
                navigate('home');
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(reg => console.log('ServiceWorker Registered', reg.scope))
                            .catch(err => console.error('ServiceWorker Registration Failed', err));
                    });
                }
                emailjs.init(EMAILJS_CONFIG.publicKey);
            };

            const loadSettings = () => {
                try {
                    const stored = localStorage.getItem(SETTINGS_KEY);
                    if (stored) state.settings = { ...state.settings, ...JSON.parse(stored) };
                    document.documentElement.className = state.settings.theme;
                } catch (e) { console.error("Failed to load settings", e); }
            };
            const saveSettings = () => localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
            const loadData = () => { try { state.data = JSON.parse(localStorage.getItem(APP_KEY)) || {}; } catch (e) { state.data = {}; } };
            const saveData = () => { try { localStorage.setItem(APP_KEY, JSON.stringify(state.data)); } catch (e) { showToast('Error saving data!', 'red'); } };

            const formatDate = (date) => date.toISOString().split('T')[0];
            const formatToDDMMYYYY = (isoDate) => {
                if (!isoDate) return '';
                const [y, m, d] = isoDate.split('-');
                return `${d}-${m}-${y}`;
            };
            const toLocalDate = (dateString) => new Date(dateString + 'T00:00:00Z');

            const getMondayOfDate = (dateString) => {
                const date = toLocalDate(dateString);
                const day = date.getDay() || 7;
                if (day !== 1) date.setHours(-24 * (day - 1));
                return formatDate(date);
            };

            const getWeekRange = (dateString) => {
                const monday = toLocalDate(getMondayOfDate(dateString));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return {
                    start: formatDate(monday),
                    end: formatDate(sunday),
                    display: `${formatToDDMMYYYY(formatDate(monday))} to ${formatToDDMMYYYY(formatDate(sunday))}`
                };
            };

            const showToast = (message, type = 'green') => {
                const toast = document.getElementById('toast-notification');
                const colors = { red: 'bg-red-500', orange: 'bg-orange-500', green: 'bg-green-500', blue: 'bg-blue-500' };
                toast.className = `fixed bottom-24 right-5 z-50 p-4 text-white font-semibold rounded-lg shadow-xl opacity-0 transform translate-y-10 ${colors[type]}`;
                toast.textContent = message;
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-10');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };

            // --- NAVIGATION ---
            const navigate = (page) => {
                state.currentPage = page;
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`nav-${page}`).classList.add('active');
                
                const contentArea = document.getElementById('content-area');
                contentArea.innerHTML = ''; // Clear content for animation
                setTimeout(() => {
                    if (page === 'home') renderDailyEntry();
                    else if (page === 'report') renderWeeklyReport();
                    else if (page === 'dashboard') renderDashboard();
                    else if (page === 'settings') renderSettings();
                }, 50);
            };

            // --- RENDER FUNCTIONS ---
            const renderDailyEntry = (date = formatDate(new Date())) => {
                const selectedDate = date;
                const entry = state.data[selectedDate] || { m: {}, d: {}, n: {} };
                const isSettled = state.data[getMondayOfDate(selectedDate)]?.settled;
                const sessions = [ { id: 'm', name: 'Morning', color: 'session-morning', data: entry.m }, { id: 'd', name: 'Day', color: 'session-day', data: entry.d }, { id: 'n', name: 'Night', color: 'session-night', data: entry.n } ];
                document.getElementById('content-area').innerHTML = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="p-4 glass-card rounded-xl flex items-center justify-between">
                            <label for="date-picker" class="font-semibold text-lg">Select Date:</label>
                            <input type="date" id="date-picker" value="${selectedDate}" onchange="App.renderDailyEntry(this.value)" class="form-input p-2 rounded-lg">
                        </div>
                        ${isSettled ? `<p class="p-4 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg text-center font-bold">🚫 This week is settled. Entries are locked.</p>` : ''}
                        <form id="daily-entry-form" class="space-y-6">
                            ${sessions.map(s => `
                                <div class="p-5 glass-card ${s.color} rounded-xl">
                                    <h3 class="text-xl font-bold mb-4">${s.name}</h3>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="${s.id}-in" class="text-sm font-medium text-gray-600 dark:text-gray-400">Tickets In</label>
                                            <input type="number" id="${s.id}-in" value="${s.data.in || ''}" oninput="App.calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="form-input p-2 rounded-lg w-full mt-1 font-semibold text-lg">
                                        </div>
                                        <div>
                                            <label for="${s.id}-return" class="text-sm font-medium text-gray-600 dark:text-gray-400">Tickets Return</label>
                                            <input type="number" id="${s.id}-return" value="${s.data.return || ''}" oninput="App.calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="form-input p-2 rounded-lg w-full mt-1 font-semibold text-lg">
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center text-md font-medium pt-3 border-t border-gray-200 dark:border-gray-700">
                                        <p>Total Sold: <span id="${s.id}-total" class="font-bold text-lg">0</span></p>
                                        <p class="text-green-600 dark:text-green-400 font-bold text-xl"><span id="${s.id}-rupees">₹0.00</span></p>
                                    </div>
                                </div>
                            `).join('')}
                            <button type="button" onclick="App.saveDailyEntry('${selectedDate}')" ${isSettled ? 'disabled' : ''} class="w-full btn btn-primary text-lg ${isSettled ? 'opacity-50 cursor-not-allowed' : ''}">
                                ${state.data[selectedDate] ? 'Update Entry' : 'Save Entry'}
                            </button>
                        </form>
                    </div>`;
                sessions.forEach(s => calculateSessionTotal(s.id));
            };
            
            const renderWeeklyReport = () => { /* ...renderWeeklyReport function from previous code... */ };
            const renderDashboard = () => { /* ...renderDashboard function from previous code... */ };
            const renderSettings = () => { /* ...renderSettings function from previous code... */ };
            
            // Re-use all logic functions from the previous version as they don't need changes.
            // This includes: calculateSessionTotal, saveDailyEntry, updateReportDate, updateDashboardDate,
            // finalizeSettlement, toggleTheme, updateSetting, handleFeedbackSubmit, generateChart,
            // exportWeeklyReportPDF, exportDataCSV, importDataCSV, clearOldRecords

             // --- LOGIC & ACTIONS ---
            const calculateSessionTotal = (sessionId) => {
                const ticketsIn = parseFloat(document.getElementById(`${sessionId}-in`).value) || 0;
                const ticketsReturn = parseFloat(document.getElementById(`${sessionId}-return`).value) || 0;
                const totalTickets = ticketsIn - ticketsReturn;
                document.getElementById(`${sessionId}-total`).textContent = totalTickets;
                document.getElementById(`${sessionId}-rupees`).textContent = `₹${(totalTickets * state.settings.rate).toFixed(2)}`;
            };
            
            const saveDailyEntry = (dateString) => {
                if (state.data[getMondayOfDate(dateString)]?.settled) {
                    showToast("Cannot save, week is settled.", 'red');
                    return;
                }
                let hasData = false;
                const newEntry = { m: {}, d: {}, n: {} };
                ['m', 'd', 'n'].forEach(id => {
                    const ticketsIn = parseFloat(document.getElementById(`${id}-in`).value) || 0;
                    const ticketsReturn = parseFloat(document.getElementById(`${id}-return`).value) || 0;
                    if (ticketsIn > 0 || ticketsReturn > 0) hasData = true;
                    newEntry[id] = { in: ticketsIn, return: ticketsReturn };
                });
                
                if (hasData) {
                    state.data[dateString] = newEntry;
                    showToast("Entry saved successfully!", 'green');
                } else {
                    delete state.data[dateString];
                    showToast("Empty entry removed.", 'orange');
                }
                saveData();
                renderDailyEntry(dateString);
            };

            const updateReportDate = (newDate) => { state.reportDate = newDate; renderWeeklyReport(); };
            
            const updateDashboardDate = (newDate) => {
                const [year, month] = newDate.split('-');
                state.dashboardDate = { year: parseInt(year), month: parseInt(month) };
                renderDashboard();
            };

            const finalizeSettlement = (mondayDate) => {
                if (state.data[mondayDate]?.settled || !confirm(`Are you sure you want to finalize and lock this week? This action cannot be undone.`)) return;
                if (!state.data[mondayDate]) state.data[mondayDate] = {};
                state.data[mondayDate].settled = true;
                saveData();
                showToast("Week settlement finalized and locked!", 'blue');
                renderWeeklyReport();
            };

            const toggleTheme = () => {
                state.settings.theme = (state.settings.theme === 'light' ? 'dark' : 'light');
                document.documentElement.className = state.settings.theme;
                saveSettings();
                navigate(state.currentPage);
            };

            const updateSetting = (key, value) => {
                state.settings[key] = value;
                saveSettings();
                showToast('Setting updated!', 'orange');
            };

            const handleFeedbackSubmit = (e) => {
                e.preventDefault();
                const form = e.target;
                const message = form.querySelector('#feedback-message').value;
                const email = form.querySelector('#feedback-email').value || 'Not provided';
                const button = form.querySelector('button');
                button.disabled = true;
                button.textContent = 'Sending...';

                const templateParams = { from_email: email, message: message };

                emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, templateParams)
                    .then(() => {
                        showToast('Feedback sent successfully. Thank you!', 'green');
                        form.reset();
                    }, (error) => {
                        showToast('Failed to send feedback. Please try again.', 'red');
                        console.error('EmailJS Error:', error);
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = 'Send Feedback';
                    });
            };

            const generateChart = () => {
                const { month, year } = state.dashboardDate;
                const daysInMonth = new Date(year, month, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                const chartData = new Array(daysInMonth).fill(0);
                
                for (const dateStr in state.data) {
                    const [dYear, dMonth, dDay] = dateStr.split('-').map(Number);
                    if (dYear === year && dMonth === month) {
                        const entry = state.data[dateStr];
                        const mTotal = (entry.m?.in || 0) - (entry.m?.return || 0);
                        const dTotal = (entry.d?.in || 0) - (entry.d?.return || 0);
                        const nTotal = (entry.n?.in || 0) - (entry.n?.return || 0);
                        chartData[dDay - 1] = (mTotal + dTotal + nTotal) * state.settings.rate;
                    }
                }

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Total Sales (₹) for ${new Date(year, month-1).toLocaleString('default', { month: 'long' })} ${year}`,
                            data: chartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            };

            const exportWeeklyReportPDF = () => { /* ... implementation from your code ... */ };
            const exportDataCSV = () => { /* ... implementation from your code ... */ };
            const importDataCSV = (event) => { /* ... implementation from your code ... */ };
            const clearOldRecords = () => { /* ... implementation from your code ... */ };

            // --- PUBLIC INTERFACE ---
            return {
                init, navigate, renderDailyEntry, calculateSessionTotal, saveDailyEntry,
                updateReportDate, finalizeSettlement, exportWeeklyReportPDF,
                updateDashboardDate,
                updateSetting, toggleTheme,
                exportDataCSV, importDataCSV, clearOldRecords
            };
        })();

        // --- START THE APP ---
        window.onload = App.init;
    </script>
</body>
</html>
