<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Ledger ‚Äì By Aavid</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.7.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --bg-light: #f4f5f7; --text-light: #1f2937; --card-light: rgba(255, 255, 255, 0.7);
            --bg-dark: #111827;  --text-dark: #e5e7eb;  --card-dark: rgba(31, 41, 55, 0.7);
            --border-light: rgba(209, 213, 219, 0.5); --border-dark: rgba(75, 85, 99, 0.5);
            --input-bg-light: #fff; --input-bg-dark: #374151;
        }
        html.dark { color-scheme: dark; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light); color: var(--text-light);
            transition: background-color 0.3s ease;
        }
        .dark body { background-color: var(--bg-dark); color: var(--text-dark); }
        .glass-card {
            background-color: var(--card-light); border: 1px solid var(--border-light);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .dark .glass-card { background-color: var(--card-dark); border-color: var(--border-dark); }
        input, select { background-color: var(--input-bg-light); }
        .dark input, .dark select { background-color: var(--input-bg-dark) !important; border-color: #4b5563 !important; color: #f3f4f6 !important; }
        .session-morning { background-color: rgba(252, 211, 77, 0.15); }
        .session-day { background-color: rgba(96, 165, 250, 0.15); }
        .session-night { background-color: rgba(52, 211, 153, 0.15); }
        #toast-notification { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .nav-btn-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }
        .nav-btn { transition: all 0.2s ease-in-out; }
        .nav-btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-500">Lottery Ledger</h1>
        </header>

        <nav class="flex justify-around bg-white/60 dark:bg-gray-800/60 p-2 rounded-xl shadow-lg mb-6 sticky top-2 z-10 backdrop-filter backdrop-blur-lg">
            <button onclick="App.navigate('home')" id="nav-home" class="nav-btn w-full font-semibold py-2 px-3 rounded-lg">üè† Entry</button>
            <button onclick="App.navigate('report')" id="nav-report" class="nav-btn w-full font-semibold py-2 px-3 rounded-lg">üìä Report</button>
            <button onclick="App.navigate('dashboard')" id="nav-dashboard" class="nav-btn w-full font-semibold py-2 px-3 rounded-lg">üìà Dashboard</button>
            <button onclick="App.navigate('settings')" id="nav-settings" class="nav-btn w-full font-semibold py-2 px-3 rounded-lg">‚öôÔ∏è Settings</button>
        </nav>

        <main id="content-area" class="transition-opacity duration-300"></main>
    </div>

    <div id="toast-notification" class="fixed bottom-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl opacity-0 transform translate-y-10"></div>

    <script>
        // =================================================================================
        // APP MODULE
        // =================================================================================
        const App = (() => {
            // --- STATE MANAGEMENT ---
            let state = {
                currentPage: 'home',
                data: {},
                settings: {
                    rate: 4.30,
                    developerName: 'Your Name',
                    theme: 'light'
                },
                reportDate: new Date().toISOString().split('T')[0],
                dashboardDate: {
                    month: new Date().getMonth() + 1,
                    year: new Date().getFullYear()
                }
            };
            const APP_KEY = 'lotteryLedgerData';
            const SETTINGS_KEY = 'lotteryLedgerSettings';

            // --- EMAILJS CONFIG ---
            const EMAILJS_CONFIG = {
                publicKey: 'cR_ecVOlooNvaufB0',
                serviceId: 'service_wc19lto',
                templateId: 'template_fp5a41g'
            };

            // --- CORE & UTILITIES ---
            const init = () => {
                loadSettings();
                loadData();
                navigate('home');
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(reg => console.log('ServiceWorker Registered', reg.scope))
                            .catch(err => console.error('ServiceWorker Registration Failed', err));
                    });
                }
                emailjs.init(EMAILJS_CONFIG.publicKey);
            };

            const loadSettings = () => {
                try {
                    const stored = localStorage.getItem(SETTINGS_KEY);
                    if (stored) state.settings = { ...state.settings, ...JSON.parse(stored) };
                    document.documentElement.className = state.settings.theme;
                } catch (e) { console.error("Failed to load settings", e); }
            };
            const saveSettings = () => localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
            const loadData = () => { try { state.data = JSON.parse(localStorage.getItem(APP_KEY)) || {}; } catch (e) { state.data = {}; } };
            const saveData = () => { try { localStorage.setItem(APP_KEY, JSON.stringify(state.data)); } catch (e) { showToast('Error saving data!', 'red'); } };

            const formatDate = (date) => date.toISOString().split('T')[0];
            const formatToDDMMYYYY = (isoDate) => {
                if (!isoDate) return '';
                const [y, m, d] = isoDate.split('-');
                return `${d}-${m}-${y}`;
            };
            const toLocalDate = (dateString) => new Date(dateString + 'T00:00:00Z');

            const getMondayOfDate = (dateString) => {
                const date = toLocalDate(dateString);
                const day = date.getDay() || 7; // Sunday: 0 -> 7
                if (day !== 1) date.setHours(-24 * (day - 1));
                return formatDate(date);
            };

            const getWeekRange = (dateString) => {
                const monday = toLocalDate(getMondayOfDate(dateString));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return {
                    start: formatDate(monday),
                    end: formatDate(sunday),
                    display: `${formatToDDMMYYYY(formatDate(monday))} to ${formatToDDMMYYYY(formatDate(sunday))}`
                };
            };

            const showToast = (message, type = 'green') => {
                const toast = document.getElementById('toast-notification');
                const colors = { red: 'bg-red-500', orange: 'bg-orange-500', green: 'bg-green-500', blue: 'bg-blue-500' };
                toast.className = `fixed bottom-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl opacity-0 transform translate-y-10 ${colors[type]}`;
                toast.textContent = message;
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-10');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };

            // --- NAVIGATION ---
            const navigate = (page) => {
                state.currentPage = page;
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-btn-active'));
                document.getElementById(`nav-${page}`).classList.add('nav-btn-active');
                
                const contentArea = document.getElementById('content-area');
                contentArea.classList.add('opacity-0');

                setTimeout(() => {
                    if (page === 'home') renderDailyEntry();
                    else if (page === 'report') renderWeeklyReport();
                    else if (page === 'dashboard') renderDashboard();
                    else if (page === 'settings') renderSettings();
                    contentArea.classList.remove('opacity-0');
                }, 200);
            };

            // --- RENDER FUNCTIONS ---
            const renderDailyEntry = (date = formatDate(new Date())) => {
                const selectedDate = date;
                const entry = state.data[selectedDate] || { m: {}, d: {}, n: {} };
                const isSettled = state.data[getMondayOfDate(selectedDate)]?.settled;
                const sessions = [ { id: 'm', name: 'Morning', color: 'session-morning', data: entry.m }, { id: 'd', name: 'Day', color: 'session-day', data: entry.d }, { id: 'n', name: 'Night', color: 'session-night', data: entry.n } ];
                document.getElementById('content-area').innerHTML = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="p-4 glass-card rounded-xl flex items-center justify-between">
                            <label for="date-picker" class="font-medium text-lg">Select Date:</label>
                            <input type="date" id="date-picker" value="${selectedDate}" onchange="App.renderDailyEntry(this.value)" class="p-2 border dark:border-gray-600 rounded-lg">
                        </div>
                        ${isSettled ? `<p class="p-4 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg text-center font-bold">üö´ This week is settled. Entries are locked.</p>` : ''}
                        <form id="daily-entry-form" class="space-y-6">
                            ${sessions.map(s => `
                                <div class="p-5 glass-card ${s.color} rounded-xl shadow-lg">
                                    <h3 class="text-xl font-bold mb-3 border-b dark:border-gray-600 pb-2">${s.name}</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="${s.id}-in" class="text-sm font-medium">Tickets In</label>
                                            <input type="number" id="${s.id}-in" value="${s.data.in || ''}" oninput="App.calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="p-2 border dark:border-gray-600 rounded-lg w-full mt-1">
                                        </div>
                                        <div>
                                            <label for="${s.id}-return" class="text-sm font-medium">Tickets Return</label>
                                            <input type="number" id="${s.id}-return" value="${s.data.return || ''}" oninput="App.calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="p-2 border dark:border-gray-600 rounded-lg w-full mt-1">
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-4 text-md font-medium pt-3 border-t dark:border-gray-600">
                                        <p>Total Tickets: <span id="${s.id}-total" class="font-bold">0</span></p>
                                        <p>Total Rupees: <span id="${s.id}-rupees" class="font-bold text-green-700 dark:text-green-400">‚Çπ0.00</span></p>
                                    </div>
                                </div>
                            `).join('')}
                            <button type="button" onclick="App.saveDailyEntry('${selectedDate}')" ${isSettled ? 'disabled' : ''} class="w-full ${state.data[selectedDate] ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'} text-white font-bold py-3 rounded-xl shadow-lg transition duration-200 ${isSettled ? 'opacity-50 cursor-not-allowed' : ''}">
                                ${state.data[selectedDate] ? 'Update Entry' : 'Save Entry'}
                            </button>
                        </form>
                    </div>`;
                sessions.forEach(s => calculateSessionTotal(s.id));
            };
            
            const renderWeeklyReport = () => {
                const weekRange = getWeekRange(state.reportDate);
                const isSettled = state.data[weekRange.start]?.settled;
                let dateCursor = toLocalDate(weekRange.start);
                let rowsHtml = '';
                let grandTotal = { in: 0, return: 0, tickets: 0, rupees: 0 };

                for (let i = 0; i < 7; i++) {
                    const dateString = formatDate(dateCursor);
                    const entry = state.data[dateString] || {};
                    const dayName = dateCursor.toLocaleDateString('en-US', { weekday: 'long' });
                    const m = { in: entry.m?.in || 0, ret: entry.m?.return || 0, total: (entry.m?.in || 0) - (entry.m?.return || 0) };
                    const d = { in: entry.d?.in || 0, ret: entry.d?.return || 0, total: (entry.d?.in || 0) - (entry.d?.return || 0) };
                    const n = { in: entry.n?.in || 0, ret: entry.n?.return || 0, total: (entry.n?.in || 0) - (entry.n?.return || 0) };
                    const daily = {
                        in: m.in + d.in + n.in,
                        return: m.ret + d.ret + n.ret,
                        tickets: m.total + d.total + n.total,
                        rupees: (m.total + d.total + n.total) * state.settings.rate
                    };
                    grandTotal.in += daily.in;
                    grandTotal.return += daily.return;
                    grandTotal.tickets += daily.tickets;
                    grandTotal.rupees += daily.rupees;

                    rowsHtml += `
                        <tr class="text-center border-b dark:border-gray-700">
                            <td class="p-3 font-medium text-left">${formatToDDMMYYYY(dateString)}<br><span class="text-xs text-gray-500">${dayName}</span></td>
                            <td class="p-2 session-morning">${m.in}</td><td class="p-2 session-morning">${m.ret}</td><td class="p-2 font-bold session-morning">${m.total}</td>
                            <td class="p-2 session-day">${d.in}</td><td class="p-2 session-day">${d.ret}</td><td class="p-2 font-bold session-day">${d.total}</td>
                            <td class="p-2 session-night">${n.in}</td><td class="p-2 session-night">${n.ret}</td><td class="p-2 font-bold session-night">${n.total}</td>
                            <td class="p-2 font-extrabold text-indigo-700 dark:text-indigo-400">‚Çπ${daily.rupees.toFixed(2)}</td>
                        </tr>
                        <tr class="bg-gray-100 dark:bg-gray-700/50 font-semibold text-center text-xs">
                            <td class="p-1 text-right">Daily Totals ‚Üí</td>
                            <td class="p-1" colspan="2">In: ${daily.in}</td>
                            <td class="p-1">Ret: ${daily.return}</td>
                            <td class="p-1" colspan="6">Sold: ${daily.tickets}</td>
                            <td class="p-1"></td>
                        </tr>
                    `;
                    dateCursor.setDate(dateCursor.getDate() + 1);
                }
                document.getElementById('content-area').innerHTML = `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-center">Weekly Report</h2>
                        <div class="p-4 glass-card rounded-xl flex items-center justify-between">
                            <label for="week-picker" class="font-medium">Select Week:</label>
                            <input type="date" id="week-picker" value="${state.reportDate}" onchange="App.updateReportDate(this.value)" class="p-2 border dark:border-gray-600 rounded-lg">
                        </div>
                        <div class="p-3 ${isSettled ? 'bg-indigo-100 dark:bg-indigo-900/50' : 'bg-green-100 dark:bg-green-900/50'} rounded-lg text-center font-bold">${isSettled ? '‚úÖ' : 'üóìÔ∏è'} Week: ${weekRange.display} ${isSettled ? '(Settled & Locked)' : ''}</div>
                        <div class="overflow-x-auto glass-card shadow-xl rounded-xl p-2">
                            <table class="min-w-full text-sm">
                                <thead class="text-xs uppercase">
                                    <tr><th rowspan="2" class="p-2">Date</th><th colspan="3" class="p-2 bg-yellow-300/50">Morning</th><th colspan="3" class="p-2 bg-blue-300/50">Day</th><th colspan="3" class="p-2 bg-green-300/50">Night</th><th rowspan="2" class="p-2">Total ‚Çπ</th></tr>
                                    <tr class="text-gray-600 dark:text-gray-400"><th>In</th><th>Ret</th><th>Sold</th><th>In</th><th>Ret</th><th>Sold</th><th>In</th><th>Ret</th><th>Sold</th></tr>
                                </thead>
                                <tbody class="bg-white/50 dark:bg-gray-800/50">${rowsHtml}</tbody>
                                <tfoot class="border-t-2 border-indigo-500">
                                    <tr class="font-extrabold text-center bg-gray-200 dark:bg-gray-700">
                                        <td class="p-2 text-right">Weekly Totals</td>
                                        <td class="p-2" colspan="2">In: ${grandTotal.in}</td>
                                        <td class="p-2">Ret: ${grandTotal.return}</td>
                                        <td class="p-2" colspan="6">Sold: ${grandTotal.tickets}</td>
                                        <td class="p-2 text-red-700 dark:text-red-400 text-lg">‚Çπ${grandTotal.rupees.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button onclick="App.exportWeeklyReportPDF()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-700 transition">üìÑ Export PDF</button>
                            <button onclick="App.finalizeSettlement('${weekRange.start}')" ${isSettled ? 'disabled' : ''} class="flex-1 ${isSettled ? 'bg-gray-500' : 'bg-green-600 hover:bg-green-700'} text-white font-bold py-3 rounded-xl shadow-lg transition ${isSettled ? 'cursor-not-allowed' : ''}">${isSettled ? '‚úÖ Settled' : 'üîí Finalize Week'}</button>
                        </div>
                    </div>`;
            };

            const renderDashboard = () => {
                const { month, year } = state.dashboardDate;
                document.getElementById('content-area').innerHTML = `
                     <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-center">Monthly Dashboard</h2>
                        <div class="p-4 glass-card rounded-xl flex items-center justify-center gap-4">
                             <input type="month" id="month-picker" value="${year}-${String(month).padStart(2, '0')}" 
                                onchange="App.updateDashboardDate(this.value)" 
                                class="p-2 border dark:border-gray-600 rounded-lg">
                        </div>
                        <div class="p-5 glass-card rounded-xl shadow-lg">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                     </div>`;
                generateChart();
            };

            const renderSettings = () => {
                 document.getElementById('content-area').innerHTML = `
                    <div class="space-y-8">
                        <h2 class="text-2xl font-bold text-center">‚öôÔ∏è Settings & Info</h2>
                        
                        <div class="p-5 glass-card rounded-xl">
                            <h3 class="text-lg font-bold border-b pb-2 mb-4">General</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium mb-1 block">Ticket Rate (‚Çπ)</label>
                                    <input type="number" value="${state.settings.rate}" step="0.01" onchange="App.updateSetting('rate', parseFloat(this.value))" class="p-2 border dark:border-gray-600 rounded-lg w-full max-w-xs">
                                </div>
                                <div>
                                    <label class="font-medium mb-1 block">Your Name (for Reports)</label>
                                    <input type="text" value="${state.settings.developerName}" onchange="App.updateSetting('developerName', this.value)" class="p-2 border dark:border-gray-600 rounded-lg w-full max-w-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <h3 class="font-medium">Theme</h3>
                                    <button onclick="App.toggleTheme()" class="p-2 rounded-lg font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-100 dark:bg-gray-700">${state.settings.theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light'}</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-5 glass-card rounded-xl">
                            <h3 class="text-lg font-bold border-b pb-2 mb-4">Feedback or Complaints</h3>
                            <form id="feedback-form" class="space-y-4">
                                <input type="email" id="feedback-email" placeholder="Your Email (Optional)" class="p-2 border dark:border-gray-600 rounded-lg w-full">
                                <textarea id="feedback-message" rows="4" placeholder="Your message..." required class="p-2 border dark:border-gray-600 rounded-lg w-full"></textarea>
                                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition">Send Feedback</button>
                            </form>
                        </div>
                        
                        <div class="p-5 glass-card rounded-xl text-center">
                            <h3 class="text-lg font-bold border-b pb-2 mb-4">About the Developer</h3>
                            <p class="mb-2">Hi, I'm a freelancing student passionate about web development.</p>
                            <div class="flex justify-center gap-4 text-sm">
                                <a href="#" class="text-indigo-500 hover:underline">GitHub</a>
                                <a href="#" class="text-indigo-500 hover:underline">Instagram</a>
                                <span>Mobile: +91 00000-00000</span>
                            </div>
                        </div>

                        <div class="p-5 glass-card rounded-xl space-y-4">
                            <h3 class="text-lg font-bold border-b pb-2">Data Management</h3>
                            <button onclick="App.exportDataCSV()" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition">üíæ Export All Data (CSV)</button>
                            <button onclick="document.getElementById('import-file').click()" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-lg hover:bg-yellow-600 transition">üì• Import Data (CSV)</button>
                            <input type="file" id="import-file" accept=".csv" class="hidden" onchange="App.importDataCSV(event)">
                            <button onclick="App.clearOldRecords()" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition">üóëÔ∏è Clear Records Older Than 30 Days</button>
                        </div>
                    </div>`;

                document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
            };

            // --- LOGIC & ACTIONS ---
            const calculateSessionTotal = (sessionId) => {
                const ticketsIn = parseFloat(document.getElementById(`${sessionId}-in`).value) || 0;
                const ticketsReturn = parseFloat(document.getElementById(`${sessionId}-return`).value) || 0;
                const totalTickets = ticketsIn - ticketsReturn;
                document.getElementById(`${sessionId}-total`).textContent = totalTickets;
                document.getElementById(`${sessionId}-rupees`).textContent = `‚Çπ${(totalTickets * state.settings.rate).toFixed(2)}`;
            };
            
            const saveDailyEntry = (dateString) => {
                if (state.data[getMondayOfDate(dateString)]?.settled) {
                    showToast("Cannot save, week is settled.", 'red');
                    return;
                }
                let hasData = false;
                const newEntry = { m: {}, d: {}, n: {} };
                ['m', 'd', 'n'].forEach(id => {
                    const ticketsIn = parseFloat(document.getElementById(`${id}-in`).value) || 0;
                    const ticketsReturn = parseFloat(document.getElementById(`${id}-return`).value) || 0;
                    if (ticketsIn > 0 || ticketsReturn > 0) hasData = true;
                    newEntry[id] = { in: ticketsIn, return: ticketsReturn };
                });
                
                if (hasData) {
                    state.data[dateString] = newEntry;
                    showToast("Entry saved successfully!", 'green');
                } else {
                    delete state.data[dateString];
                    showToast("Empty entry removed.", 'orange');
                }
                saveData();
                renderDailyEntry(dateString);
            };

            const updateReportDate = (newDate) => { state.reportDate = newDate; renderWeeklyReport(); };
            
            const updateDashboardDate = (newDate) => {
                const [year, month] = newDate.split('-');
                state.dashboardDate = { year: parseInt(year), month: parseInt(month) };
                renderDashboard();
            };

            const finalizeSettlement = (mondayDate) => {
                if (state.data[mondayDate]?.settled || !confirm(`Are you sure you want to finalize and lock this week? This action cannot be undone.`)) return;
                if (!state.data[mondayDate]) state.data[mondayDate] = {};
                state.data[mondayDate].settled = true;
                saveData();
                showToast("Week settlement finalized and locked!", 'blue');
                renderWeeklyReport();
            };

            const toggleTheme = () => {
                state.settings.theme = (state.settings.theme === 'light' ? 'dark' : 'light');
                document.documentElement.className = state.settings.theme;
                saveSettings();
                navigate(state.currentPage);
            };

            const updateSetting = (key, value) => {
                state.settings[key] = value;
                saveSettings();
                showToast('Setting updated!', 'orange');
            };

            const handleFeedbackSubmit = (e) => {
                e.preventDefault();
                const form = e.target;
                const message = form.querySelector('#feedback-message').value;
                const email = form.querySelector('#feedback-email').value || 'Not provided';
                const button = form.querySelector('button');
                button.disabled = true;
                button.textContent = 'Sending...';

                const templateParams = { from_email: email, message: message };

                emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, templateParams)
                    .then(() => {
                        showToast('Feedback sent successfully. Thank you!', 'green');
                        form.reset();
                    }, (error) => {
                        showToast('Failed to send feedback. Please try again.', 'red');
                        console.error('EmailJS Error:', error);
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = 'Send Feedback';
                    });
            };

            const generateChart = () => {
                const { month, year } = state.dashboardDate;
                const daysInMonth = new Date(year, month, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                const chartData = new Array(daysInMonth).fill(0);
                
                for (const dateStr in state.data) {
                    const [dYear, dMonth, dDay] = dateStr.split('-').map(Number);
                    if (dYear === year && dMonth === month) {
                        const entry = state.data[dateStr];
                        const mTotal = (entry.m?.in || 0) - (entry.m?.return || 0);
                        const dTotal = (entry.d?.in || 0) - (entry.d?.return || 0);
                        const nTotal = (entry.n?.in || 0) - (entry.n?.return || 0);
                        chartData[dDay - 1] = (mTotal + dTotal + nTotal) * state.settings.rate;
                    }
                }

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Total Sales (‚Çπ) for ${new Date(year, month-1).toLocaleString('default', { month: 'long' })} ${year}`,
                            data: chartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            };

            // --- DATA MANAGEMENT & PDF ---
            const exportWeeklyReportPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                const weekRange = getWeekRange(state.reportDate);
                const body = [];
                let grandTotal = { in: 0, return: 0, tickets: 0, rupees: 0 };
                let dateCursor = toLocalDate(weekRange.start);

                for (let i = 0; i < 7; i++) {
                    const dateString = formatDate(dateCursor);
                    const entry = state.data[dateString] || {};
                    const m = { in: entry.m?.in || 0, ret: entry.m?.return || 0, total: (entry.m?.in || 0) - (entry.m?.return || 0) };
                    const d = { in: entry.d?.in || 0, ret: entry.d?.return || 0, total: (entry.d?.in || 0) - (entry.d?.return || 0) };
                    const n = { in: entry.n?.in || 0, ret: entry.n?.return || 0, total: (entry.n?.in || 0) - (entry.n?.return || 0) };
                    const daily = {
                        in: m.in + d.in + n.in,
                        return: m.ret + d.ret + n.ret,
                        tickets: m.total + d.total + n.total,
                        rupees: (m.total + d.total + n.total) * state.settings.rate
                    };
                    grandTotal.in += daily.in; grandTotal.return += daily.return; grandTotal.tickets += daily.tickets; grandTotal.rupees += daily.rupees;
                    
                    body.push([ `${formatToDDMMYYYY(dateString)} (${dateCursor.toLocaleDateString('en-US', { weekday: 'short' })})`, m.in, m.ret, m.total, d.in, d.ret, d.total, n.in, n.ret, n.total, `Rs. ${daily.rupees.toFixed(2)}` ]);
                    body.push([{ content: `Daily Total -> In: ${daily.in}, Return: ${daily.return}, Sold: ${daily.tickets}`, colSpan: 11, styles: { fillColor: [240, 240, 240], textColor: [50, 50, 50], fontStyle: 'italic', fontSize: 8, halign: 'right' } }]);
                    dateCursor.setDate(dateCursor.getDate() + 1);
                }
                
                doc.setFontSize(18);
                doc.text('Weekly Ticket Sales Report', doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
                doc.setFontSize(11);
                doc.text(`Name: ${state.settings.developerName}`, 40, 60);
                doc.text(`Week: ${weekRange.display}`, 40, 75);
                doc.autoTable({
                    startY: 90,
                    head: [['Date', 'Morning In', 'Morning Ret', 'M Total', 'Day In', 'Day Ret', 'D Total', 'Night In', 'Night Ret', 'N Total', 'Total Rs.']],
                    body: body,
                    theme: 'grid',
                    headStyles: { fontStyle: 'bold', fillColor: [220, 220, 220], textColor: [0, 0, 0] },
                    foot: [[{ content: `Weekly Total -> In: ${grandTotal.in}, Return: ${grandTotal.return}, Sold: ${grandTotal.tickets}`, colSpan: 10, styles: { halign: 'right', fontStyle: 'bold' } }, { content: `Rs. ${grandTotal.rupees.toFixed(2)}`, styles: { fontStyle: 'bold' } }]],
                });
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`¬© ${new Date().getFullYear()} ${state.settings.developerName} | Developed by Aavid`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 20, { align: 'center' });
                }
                doc.save(`Report_${weekRange.start}_to_${weekRange.end}.pdf`);
                showToast("PDF report is downloading...", 'blue');
            };

            const exportDataCSV = () => { /* ... implementation from your code ... */ };
            const importDataCSV = (event) => { /* ... implementation from your code ... */ };
            const clearOldRecords = () => { /* ... implementation from your code ... */ };

            // --- PUBLIC INTERFACE ---
            return {
                init, navigate, renderDailyEntry, calculateSessionTotal, saveDailyEntry,
                updateReportDate, finalizeSettlement, exportWeeklyReportPDF,
                updateDashboardDate,
                updateSetting, toggleTheme,
                exportDataCSV, importDataCSV, clearOldRecords
            };
        })();

        // --- START THE APP ---
        window.onload = App.init;
    </script>
</body>
</html>

